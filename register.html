<form id="registerForm" class="register-form">
    <h2 class="form-title">注册</h2>
    <div class="form-group">
        <label for="username" class="form-label">用户名</label>
        <input type="text" id="username" class="form-control" placeholder="请输入新用户名" required>
    </div>
    <div class="form-group">
        <label for="email" class="form-label">邮箱</label>
        <div class="email-verify-group">
            <input type="email" id="email" class="form-control" placeholder="请输入邮箱" required>
            <button type="button" id="getVerifyCode" class="btn btn-secondary">获取验证码</button>
        </div>
    </div>
    <div class="form-group">
        <label for="verifyCode" class="form-label">验证码</label>
        <input type="text" id="verifyCode" class="form-control" placeholder="请输入验证码" required>
    </div>
    <div class="form-group">
        <label for="password" class="form-label">密码</label>
        <input type="password" id="password" class="form-control" placeholder="请输入新密码" required>
    </div>
    <button type="submit" class="btn btn-primary btn-block">注册</button>
    <p class="form-tip">已有账号？<a href="login.html">立即登录</a></p>
</form>

<style>
.email-verify-group {
    display: flex;
    gap: 10px;
}

.email-verify-group input {
    flex: 1;
}

#getVerifyCode {
    white-space: nowrap;
    min-width: 100px;
}

#getVerifyCode:disabled {
    background-color: #ccc;
    cursor: not-allowed;
}
</style>

<script>
document.getElementById('getVerifyCode').addEventListener('click', async function() {
    const email = document.getElementById('email').value;
    if (!email) {
        alert('请先输入邮箱');
        return;
    }
    
    // 验证邮箱格式
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(email)) {
        alert('请输入有效的邮箱地址');
        return;
    }

    const button = this;
    button.disabled = true;
    let countdown = 60;
    
    try {
        // 发送验证码请求
        const response = await fetch('/api/send-verify-code', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ email })
        });
        
        if (!response.ok) {
            throw new Error('发送验证码失败');
        }
        
        // 开始倒计时
        const timer = setInterval(() => {
            button.textContent = `${countdown}秒后重试`;
            countdown--;
            
            if (countdown < 0) {
                clearInterval(timer);
                button.disabled = false;
                button.textContent = '获取验证码';
            }
        }, 1000);
        
    } catch (error) {
        alert(error.message);
        button.disabled = false;
        button.textContent = '获取验证码';
    }
});

// 修改注册表单提交处理
document.getElementById('registerForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const username = document.getElementById('username').value;
    const password = document.getElementById('password').value;
    const email = document.getElementById('email').value;
    const verifyCode = document.getElementById('verifyCode').value;
    
    try {
        // 验证验证码
        const verifyResponse = await fetch('/api/verify-code', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ email, code: verifyCode })
        });
        
        if (!verifyResponse.ok) {
            throw new Error('验证码错误');
        }
        
        // 继续注册流程
        const response = await fetch('/api/register', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ username, password, email })
        });
        
        if (!response.ok) {
            throw new Error('注册失败');
        }
        
        alert('注册成功！');
        window.location.href = 'login.html';
        
    } catch (error) {
        alert(error.message);
    }
});
</script> 